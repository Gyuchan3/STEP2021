# 宿題1

コード: [matrix.c](https://github.com/Gyuchan3/STEP2021/blob/main/class7/matrix.c)

## 予想

ループ順序と最内ループのメモリアクセスの仕方は下表のようになる。最内ループでのメモリアクセスの値が不変である場合は、2つ目のループでのアクセスの仕方も考慮した。

| ループ順序 | c[i][j]     | a[i][k]          | b[k][j]          | 予想 |
| ----- | ---------------- | ---------------- | ---------------- | -----|
| i-j-k | 不変、連続       | 連続             | 連続でない       | 3    |
| i-k-j | 連続             | 不変、連続       | 連続             | 1    |
| j-i-k | 不変、連続でない | 連続             | 連続でない       | 4    |
| j-k-i | 連続でない       | 連続でない       | 不変、連続でない | 6    |
| k-i-j | 連続             | 不変、連続でない | 連続             | 2    |
| k-j-i | 連続でない       | 連続でない       | 不変、連続       | 5    |

メモリアクセスができるだけ不変または連続であるほうが実行速度は速いので、
i-k-j >= k-i-j >> i-j-k >=j-i-k >> k-j-i >= j-k-iの順に実行速度が速いと考えた。

## 結果

```
gcc matrix.c -o matrix
./matrix 1500
```

を実行した時、ループ順序と実行時間の関係は下表のようになった。実行時間は3回測定し平均をとった。 結果はi-k-j > k-i-j > j-i-k > i-j-k > k-j-i >= j-k-iとなった。

| ループ順序 | 実行時間 | 結果| 予想|
| ------ | ----------- | ---- |----|
| i-j-k  | 45.98218967 | 4    |3|
| i-k-j  | 12.97484267 | 1    |1|
| j-i-k  | 20.70521033 | 3    |4|
| j-k-i  | 55.82119667 | 6    |6|
| k-i-j  | 13.245358   | 2    |2|
| k-j-i  | 54.42283867 | 5    |5|

i-j-kがj-i-kよりも2倍以上遅いのが予想外だった。最内ループでのメモリアクセスが連続かどうかには差がないのになぜだろう。

# 宿題2

Pythonではループ順序を入れ替えても速度差がほとんどないのはなぜか。

コンパイラでは実行にかかる時間は機械語の実行による時間のみで、その内の主な時間は行列積の計算の3重forループのメモリアクセスであるからループ順序の影響が大きい。一方インタプリタであるPythonでは実行にかかる時間の主な部分は字句解析、それをもとにした構文解析、構文木の評価であり、メモリアクセスは実行時間への影響が小さいためループ順序を変えても速度差がほとんどなくなるのだと思う。

# 宿題3

コード: [tsp.c](https://github.com/Gyuchan3/STEP2021/blob/main/class7/google-step-tsp-main/tsp.c)

## 実行方法

google-step-tsp-mainディレクトリに移動する。
```
$ gcc tsp.c -o tsp -lm
$ ./tsp N(csvファイルの番号)
```
とするとチャレンジ毎の結果がでる。`-O3`オプションをつけると実行時間が短くなる。

## 工夫した点

+ class5で書いたコードをC言語に書き換えた。
+ class5のコードでは2-optでクロスを見つける部分にランダム性があったのを、[Hisokalalalaさんのコード](https://github.com/Hisokalalala/step2/blob/master/google-step-tsp/solver_myself.py)を参考に改良した。
+ 貪欲法の初期解を求めるにあたり、すべての都市を初期値点としているが、コマンドライン引数でどの部分の都市を初期値点とするかを分割できるようにした。
  ```
  $ ./tsp N split
  ```
  として実行すると
  | split | 初期値点の区間|
  | -----| ---------|
  | デフォルト(0)| 0 ~ n - 1|
  |1|0 ~ n / 4 - 1|
  |2|n / 4 ~ n / 2 - 1|
  |3|n / 2 ~ n * 3 / 4 - 1|
  |4|n * 3 / 4 ~ n - 1|

  のように初期値点の範囲が変わる。複数のターミナルを立ち上げてsplitの値を変えて実行することで並列化もできるようにした。